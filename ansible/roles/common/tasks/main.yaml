---
- name: Configure Floating IP
  hosts: workers
  become: yes  # This ensures that Ansible runs the commands with elevated privileges (e.g., sudo)
  tasks:
    - name: Fetch the dynamic IP address of the worker node
      set_fact:
        worker_node_ip: "{{ ansible_default_ipv4.address }}"
      delegate_to: localhost  # Run this task on the Ansible control node

    - name: Create Directory
      file:
        path: /etc/network/interfaces.d
        state: directory
        mode: '0755'

    - name: Create the /etc/network/interfaces.d/60-floating-ip.cfg file
      copy:
        dest: "/etc/network/interfaces.d/60-floating-ip.cfg"
        content: |
          auto eth0:1
          iface eth0:1 inet static
              address {{ worker_node_ip }}
              netmask 32

    - name: Restart networking service
      service:
        name: systemd-networkd.service
        state: restarted

- hosts: all
  tasks:
    - name: Install kube-dependencies task
      ansible.builtin.import_tasks:
        file: kube-dependencies.yaml

- hosts: masters
  become: yes
  tasks:
    - name: install Kubectl
      apt:
        name: kubectl=1.29.*
        state: present
        force: yes # allow downgrades

- hosts: masters
  become: yes
  tasks:
    - name: Setup Kubernetes Master node
      ansible.builtin.import_tasks:
        file: master.yaml

- hosts: all
  become: yes
  tasks:
    - name: get join command
      shell: kubeadm token create --print-join-command
      register: join_command_raw
      delegate_to: root@MASTER_NODE_IP

    - name: set join command as a host variable
      set_fact:
        join_command: "{{ join_command_raw.stdout_lines[0] }}"
      delegate_to: localhost

- hosts: workers
  become: yes
  tasks:
    - name: TCP port 6443 on master is reachable from worker
      wait_for: "host=MASTER_NODE_IP port=6443 timeout=1"

    - name: join cluster
      shell: "{{ join_command }}"
